<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1295059805208143"
     crossorigin="anonymous"></script> 
<title>Cube Snake</title>
<style>
  :root{
    /* Skor kartını küçülttük */
    --cardW: clamp(180px, 16vw, 240px);
    --gap: 16px;
    --pad: 16px;
  }
  *{box-sizing:border-box}
  html,body{
    height:100%; margin:0; background:#0e0f12; color:#e7ebf3;
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    overflow:hidden;
  }

  /* === 3 kolonlu grid ===
     [sol-spacer][OYUN][skor kartı]
     Sol spacer, kartla aynı genişlikte: Böylece oyun GERÇEK sayfa merkezine oturur. */
  .layout{
    height:100vh; width:100vw; padding:var(--pad);
    display:grid; gap:var(--gap); align-items:center; justify-items:center;
    grid-template-columns: var(--cardW) auto var(--cardW);
  }

  /* Dar ekranda dikey dizil: oyun üstte, skor kartı altta */
  @media (max-width: 1000px){
    .layout{
      grid-template-columns: 1fr;
      grid-template-rows: auto auto;
      justify-items:center;
    }
    .spacer{ display:none }
  }

  .game-wrap{ position:relative; display:flex; align-items:center; justify-content:center }
  .hud{
    position:absolute; left:0; top:-24px; padding:6px 10px; border-radius:10px;
    background:rgba(20,22,27,.65); font-weight:700; backdrop-filter:blur(4px)
  }
  #game{
    background:#0b0c10; border:1px solid #1f2430; box-shadow:0 10px 40px rgba(0,0,0,.35);
    transform-origin: top left; display:block;
  }

  /* Küçültülmüş skor kartı */
  .sidebar{ width:var(--cardW); max-width:92vw; height:80vh; display:flex; align-items:stretch }
  .card{
    background:#181a20; border:1px solid #1f2430; border-radius:14px; padding:10px;
    box-shadow:0 8px 24px rgba(0,0,0,.25); overflow:auto;
    font-size: clamp(11px, 1.1vw, 12px);
  }
  .card h3{ margin:0 0 6px; font-size: clamp(12px, 1.3vw, 14px) }
  table.lb{ width:100%; border-collapse:collapse }
  table.lb th, table.lb td{
    padding:4px 6px; border-bottom:1px solid #242833; text-align:left;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  table.lb th:nth-child(1), table.lb td:nth-child(1){ width:36px }
  table.lb th:nth-child(3), table.lb td:nth-child(3){ text-align:right; width:50px }
  .fine{ opacity:.75 }

  /* Overlay’ler */
  .overlay{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background:linear-gradient(180deg,rgba(9,10,14,.92),rgba(9,10,14,.88));
    z-index:10; padding:16px;
  }
  .form{
    width:min(92vw,420px); background:#181a20; border:1px solid #232937; color:#e7ebf3;
    border-radius:16px; padding:20px; box-shadow:0 14px 36px rgba(0,0,0,.4)
  }
  .form h1{ margin:0 0 6px; font-size:20px }
  .row{ margin-top:12px }
  .row input[type="text"]{
    width:100%; padding:12px 14px; border-radius:10px; border:1px solid #2a2e36;
    background:#0f1116; color:#e7ebf3; outline:none
  }
  .row button{
    width:100%; padding:12px; border:0; border-radius:12px; background:#4f7cff; color:#fff;
    font-weight:800; cursor:pointer; margin-top:10px
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<main class="layout">
  <!-- sol spacer oyun merkezini dengeler -->
  <div class="spacer" aria-hidden="true"></div>

  <!-- Oyun kolonu (tam sayfa merkezi) -->
  <section class="game-col">
    <div class="game-wrap" id="gameWrap">
      <div class="hud">Skor: <span id="score">0</span></div>
      <canvas id="game" width="560" height="560" role="img" aria-label="Yılan Oyunu"></canvas>
    </div>
  </section>

  <!-- Sağdaki küçük skor kartı -->
  <aside class="sidebar">
    <div class="card">
      <h3>Top 10 (Global)</h3>
      <table class="lb" aria-live="polite">
        <thead><tr><th>#</th><th>İsim</th><th>Skor</th></tr></thead>
        <tbody id="top10g"><tr><td colspan="3">Bağlanıyor…</td></tr></tbody>
      </table>
      <div id="lbStatus" class="fine"></div>
    </div>
  </aside>
</main>

<!-- Başlangıç -->
<div class="overlay" id="startOverlay" aria-modal="true" role="dialog">
  <div class="form">
    <h1>Yılan</h1>
    <div class="fine">Ok tuşları / WASD. Kendine ya da duvara çarpınca biter.</div>
    <div class="row">
      <label for="playerName">İsmin</label>
      <input id="playerName" type="text" placeholder="ör. Boss" maxlength="20"/>
      <button id="startBtn" type="button">Başla</button>
    </div>
  </div>
</div>

<!-- Oyun Bitti -->
<div class="overlay" id="gameOverOverlay" style="display:none" aria-modal="true" role="dialog">
  <div class="form">
    <h1>Oyun Bitti</h1>
    <div class="row">Skorun: <b id="finalScore">0</b></div>
    <div class="row"><button id="retryBtn" type="button">Tekrar Başla</button></div>
  </div>
</div>

<script>
window.addEventListener('DOMContentLoaded', () => {
  'use strict';

  /* ==== Sabitler ==== */
  const GRID=28, CELL=20, SPEED_START=8, SPEED_INC_EVERY=5;

  /* ==== DOM ==== */
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const scoreEl = document.getElementById('score');
  const overlay = document.getElementById('startOverlay');
  const gameOverOverlay = document.getElementById('gameOverOverlay');
  const finalScoreEl = document.getElementById('finalScore');
  const retryBtn = document.getElementById('retryBtn');
  const nameInput = document.getElementById('playerName');
  const startBtn = document.getElementById('startBtn');
  const top10gEl = document.getElementById('top10g');
  const lbStatusEl = document.getElementById('lbStatus');

  canvas.width = GRID*CELL; canvas.height = GRID*CELL;

  /* ==== Supabase (opsiyonel) ==== */
  const SUPABASE_URL  = window.__SUPABASE_URL  || 'https://obrtgsafmdpztkkckpcx.supabase.co';
  const SUPABASE_ANON = window.__SUPABASE_ANON || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9icnRnc2FmbWRwenRra2NrcGN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODQzOTksImV4cCI6MjA3NDk2MDM5OX0.yGWrE7kbo1ofi0q_rAeKt4YjS0D0GLwjA8DFQ1SV5Fw';
  let supa=null;
  try{ if(window.supabase){ supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {auth:{persistSession:false}}); } }catch(_){}
  const esc = s=>String(s).replace(/[&<>\"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));

  async function lbSubmitGlobal(name, score){
    if(!supa || score<2) return;
    try{ const {error}=await supa.from('scores').insert({name:(name||'Anon').slice(0,20),score}); if(error) lbStatusEl.textContent='Skor kaydedilemedi.'; }
    catch(_){ lbStatusEl.textContent='Skor kaydedilemedi.'; }
  }
  async function lbLoadGlobal(){
    if(!supa){ top10gEl.innerHTML='<tr><td colspan="3">Leaderboard pasif.</td></tr>'; return; }
    const {data,error}=await supa.from('scores').select('name,score').order('score',{ascending:false}).limit(10);
    if(error){ top10gEl.innerHTML=`<tr><td colspan="3">Hata: ${esc(error.message||'')}</td></tr>`; return; }
    if(!data?.length){ top10gEl.innerHTML='<tr><td colspan="3">Henüz skor yok</td></tr>'; return; }
    top10gEl.innerHTML=data.map((r,i)=>`<tr><td>${i+1}</td><td>${esc(r.name||'Anon')}</td><td>${r.score}</td></tr>`).join('');
  }

  /* ==== Oyun durumu ==== */
  let PLAYER_NAME='', snake, dir, pendingDir, food, score, speed, tickTime, eatenCount, last, running=false;
  function reset(){
    snake=[{x:Math.floor(GRID/2),y:Math.floor(GRID/2)}];
    dir=pendingDir={x:1,y:0};
    score=0; speed=SPEED_START; eatenCount=0; last=0; tickTime=1000/speed;
    spawnFood(); scoreEl.textContent='0'; drawGrid();
  }
  function spawnFood(){
    while(true){
      const f={x:(Math.random()*GRID)|0,y:(Math.random()*GRID)|0};
      if(!snake.some(s=>s.x===f.x&&s.y===f.y)){ food=f; return; }
    }
  }

  /* ==== Giriş ==== */
  window.addEventListener('keydown', e=>{
    if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' '].includes(e.key)) e.preventDefault();
    if(!running) return;
    const k=e.key.toLowerCase();
    if(e.code==='ArrowUp'   && dir.y!== 1) pendingDir={x:0,y:-1};
    if(e.code==='ArrowDown' && dir.y!==-1) pendingDir={x:0,y: 1};
    if(e.code==='ArrowLeft' && dir.x!== 1) pendingDir={x:-1,y:0};
    if(e.code==='ArrowRight'&& dir.x!==-1) pendingDir={x: 1,y:0};
    if(k==='w' && dir.y!== 1) pendingDir={x:0,y:-1};
    if(k==='s' && dir.y!==-1) pendingDir={x:0,y: 1};
    if(k==='a' && dir.x!== 1) pendingDir={x:-1,y:0};
    if(k==='d' && dir.x!==-1) pendingDir={x: 1,y:0};
  }, {passive:false});

  /* ==== Çizim ==== */
  function drawGrid(){
    ctx.fillStyle='#0b0c10'; ctx.fillRect(0,0,canvas.width,canvas.height);
    const ox=0.5; ctx.strokeStyle='#6a7fa3'; ctx.lineWidth=2.6; ctx.lineCap='butt'; ctx.lineJoin='miter';
    ctx.beginPath();
    for(let i=0;i<=GRID;i++){
      const x=i*CELL+ox, y=i*CELL+ox;
      ctx.moveTo(x,0); ctx.lineTo(x,GRID*CELL);
      ctx.moveTo(0,y); ctx.lineTo(GRID*CELL,y);
    }
    ctx.stroke();
    ctx.save(); ctx.strokeStyle='#90a8cf'; ctx.lineWidth=3.4; ctx.strokeRect(0.5,0.5,canvas.width-1,canvas.height-1); ctx.restore();
  }
  function drawSnake(){
    ctx.fillStyle='rgba(0,0,0,.18)';
    snake.forEach(s=>ctx.fillRect(s.x*CELL+2,s.y*CELL+2,CELL-4,CELL-2));
    ctx.fillStyle='#35c97a';
    snake.forEach(s=>ctx.fillRect(s.x*CELL+1,s.y*CELL+1,CELL-2,CELL-2));
    const h=snake[0]; ctx.fillStyle='#62e5a1'; ctx.fillRect(h.x*CELL+1,h.y*CELL+1,CELL-2,CELL-2);
  }
  function drawFood(){
    ctx.fillStyle='#ff5f5f';
    const r=CELL/2-3; ctx.beginPath();
    ctx.arc(food.x*CELL+CELL/2, food.y*CELL+CELL/2, r, 0, Math.PI*2); ctx.fill();
  }

  /* ==== Döngü ==== */
  function step(ts){
    if(!running) return;
    if(!last) last=ts;
    const dt=ts-last;
    if(dt>=tickTime){
      last=ts; dir=pendingDir;
      const nx=snake[0].x+dir.x, ny=snake[0].y+dir.y;
      if(nx<0||nx>=GRID||ny<0||ny>=GRID||snake.some(s=>s.x===nx&&s.y===ny)){ gameOver(); return; }
      snake.unshift({x:nx,y:ny});
      if(nx===food.x && ny===food.y){
        score++; eatenCount++; scoreEl.textContent=String(score); spawnFood();
        if(eatenCount%SPEED_INC_EVERY===0){ speed++; tickTime=1000/speed; }
      }else snake.pop();
    }
    drawGrid(); drawFood(); drawSnake();
    requestAnimationFrame(step);
  }
  function gameOver(){
    running=false;
    finalScoreEl.textContent=String(score);
    gameOverOverlay.style.display='flex';
    lbSubmitGlobal(PLAYER_NAME,score).then(lbLoadGlobal);
  }

  /* ==== Responsive ölçek ====
     Oyun, merkezdeki kolonda durur. Görünen genişlik:
       viewport - 2*cardW - kenar boşlukları */
  function fitScale(){
    // 2 kart sütunu kadar alanı düş
    const cardW = Math.max(
      document.querySelector('.sidebar')?.getBoundingClientRect().width || 0,
      parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cardW')) || 0
    );

    const availW = Math.max(320, window.innerWidth  - 2*cardW - 2*parseInt(getComputedStyle(document.body).getPropertyValue('--pad')||'16') - 20);
    const availH = Math.max(320, window.innerHeight - 140);

    const sx = availW / canvas.width;
    const sy = availH / canvas.height;

    // Kısa ekranlarda tavan ölçek
    const vh = window.innerHeight;
    let cap=1.0; if(vh<900) cap=.85; if(vh<820) cap=.75; if(vh<740) cap=.68; if(vh<680) cap=.60;

    const s=Math.max(.5, Math.min(sx, sy, cap));
    canvas.style.transform=`scale(${s})`;
  }

  /* ==== Başlat/tekrar ==== */
  function startGame(){
    try{
      PLAYER_NAME = (nameInput?.value||'').trim().slice(0,20) || 'Anon';
      overlay.style.display='none';
      reset(); running=true;
      lbLoadGlobal();
      requestAnimationFrame(step);
      fitScale();
    }catch(err){
      console.error('Start hatası:', err);
      overlay.style.display='none'; reset(); running=true; requestAnimationFrame(step);
    }
  }
  startBtn.addEventListener('click', startGame);
  nameInput.addEventListener('keydown', e=>{ if(e.key==='Enter') startGame(); });
  retryBtn.addEventListener('click', ()=>{ gameOverOverlay.style.display='none'; reset(); running=true; requestAnimationFrame(step); });

  // İlk çizim + dinleyiciler
  drawGrid(); fitScale(); window.addEventListener('resize', fitScale);
});
</script>
</body>
</html>
