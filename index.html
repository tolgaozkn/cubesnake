<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cube Snake</title>
<style>
  :root{ --gap:20px; --pad:16px; }
  *{box-sizing:border-box}
  html,body{ height:100%; margin:0; background:#0e0f12; color:#e7ebf3;
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    overflow:hidden; /* sayfa scrol etmiyor; biz sığdırıyoruz */
  }

  /* Tam ekran grid: solda oyun, sağda skor kartı. İki taraf da DİKEY+YATAY ortalı. */
  .layout{
    height:100vh; width:100vw;
    display:grid;
    grid-template-columns: minmax(0,1fr) 360px;
    gap:var(--gap);
    align-items:center;     /* dikey ortalama */
    justify-items:center;   /* yatay ortalama */
    padding:var(--pad);
  }
  @media (max-width:1200px){
    .layout{ grid-template-columns:1fr; grid-template-rows: 1fr auto; }
  }

  /* Oyun sütunu: sadece ortalama */
  .game-col{
    height:100%; width:100%;
    display:flex; align-items:center; justify-content:center;
    min-width:320px; min-height:320px;
  }

  /* Oyun alanı sarmalayıcı: merkez ve referans */
  .game-wrap{
    position:relative;
    display:flex; align-items:center; justify-content:center;
    /* Bu kutunun boyutu önemli değil; ölçek JS ile ayarlanacak */
  }

  /* Skor etiketi: canvas’ın tam sol üstü */
  .hud{
    position:absolute; left:0; top:-24px;
    background:rgba(20,22,27,.65); padding:6px 10px; border-radius:10px;
    font-weight:700; backdrop-filter: blur(4px);
  }

  /* Canvas */
  #game{
    background:#0b0c10; border:1px solid #1f2430; border-radius:0;
    box-shadow:0 10px 40px rgba(0,0,0,.35);
    transform-origin:top left;
    display:block;
  }

  /* Skor kartı */
  .sidebar{width:360px; max-width:92vw; height:80vh; display:flex; align-items:stretch}
  .card{background:#181a20; border:1px solid #1f2430; border-radius:16px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.25); overflow:auto}
  .card h3{margin:0 0 8px; font-size:16px}
  table.lb{width:100%; border-collapse:collapse; font-size:14px}
  table.lb th,table.lb td{padding:6px 8px; border-bottom:1px solid #242833; text-align:left}
  table.lb th:nth-child(1),table.lb td:nth-child(1){width:60px}
  table.lb th:nth-child(3),table.lb td:nth-child(3){text-align:right; width:80px}
  .fine{font-size:12px; opacity:.75}

  /* Overlays */
  .overlay{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg,rgba(9,10,14,.92),rgba(9,10,14,.88)); z-index:10; padding:16px}
  .form{width:min(92vw,420px); background:#181a20; border:1px solid #232937; color:#e7ebf3; border-radius:16px; padding:20px; box-shadow:0 14px 36px rgba(0,0,0,.4)}
  .form h1{margin:0 0 6px; font-size:20px}
  .row{margin-top:12px}
  .row input[type="text"]{width:100%; padding:12px 14px; border-radius:10px; border:1px solid #2a2e36; background:#0f1116; color:#e7ebf3; outline:none}
  .row button{width:100%; padding:12px; border:0; border-radius:12px; background:#4f7cff; color:#fff; font-weight:800; cursor:pointer; margin-top:10px}

  .toast{position:fixed; right:16px; top:16px; background:#1b1f27; color:#cfe0ff; padding:10px 12px; border-radius:10px; border:1px solid #273049; display:none; z-index:20}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<main class="layout">
  <section class="game-col">
    <div class="game-wrap" id="gameWrap">
      <div class="hud">Skor: <span id="score">0</span></div>
      <!-- Orijinal boyut (GRID*CELL) → 560×560. JS, ölçeklemeyi aşağı çeker. -->
      <canvas id="game" width="560" height="560" role="img" aria-label="Yılan Oyunu"></canvas>
    </div>
  </section>

  <aside class="sidebar">
    <div class="card">
      <h3>Top 10 (Global)</h3>
      <table class="lb" aria-live="polite">
        <thead><tr><th>#</th><th>İsim</th><th>Skor</th></tr></thead>
        <tbody id="top10g"><tr><td colspan="3">Bağlanıyor…</td></tr></tbody>
      </table>
      <div id="lbStatus" class="fine"></div>
    </div>
  </aside>
</main>

<!-- Başlangıç -->
<div class="overlay" id="startOverlay" aria-modal="true" role="dialog">
  <div class="form">
    <h1>Yılan</h1>
    <div class="fine">Ok tuşları / WASD ile hareket et. Kendine ya da duvara çarparsan biter.</div>
    <div class="row">
      <label for="playerName">İsmin</label>
      <input id="playerName" type="text" placeholder="ör. Boss" maxlength="20" />
      <button id="startBtn">Başla</button>
    </div>
  </div>
</div>

<!-- Oyun Bitti -->
<div class="overlay" id="gameOverOverlay" style="display:none" aria-modal="true" role="dialog">
  <div class="form">
    <h1>Oyun Bitti</h1>
    <div class="row">Skorun: <b id="finalScore">0</b></div>
    <div class="row"><button id="retryBtn">Tekrar Başla</button></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(() => {
  'use strict';

  /* ==== Ayarlar ==== */
  const GRID = 28, CELL = 20;                 // 28*20 = 560 px
  const SPEED_START = 8, SPEED_INC_EVERY = 5;

  /* ==== DOM ==== */
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const scoreEl = document.getElementById('score');
  const overlay = document.getElementById('startOverlay');
  const gameOverOverlay = document.getElementById('gameOverOverlay');
  const finalScoreEl = document.getElementById('finalScore');
  const retryBtn = document.getElementById('retryBtn');
  const nameInput = document.getElementById('playerName');
  const startBtn = document.getElementById('startBtn');
  const gameWrap = document.getElementById('gameWrap');

  canvas.width = GRID * CELL; canvas.height = GRID * CELL;

  /* ==== Supabase ==== */
  const SUPABASE_URL  = window.__SUPABASE_URL  || 'https://obrtgsafmdpztkkckpcx.supabase.co';
  const SUPABASE_ANON = window.__SUPABASE_ANON || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9icnRnc2FmbWRwenRra2NrcGN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODQzOTksImV4cCI6MjA3NDk2MDM5OX0.yGWrE7kbo1ofi0q_rAeKt4YjS0D0GLwjA8DFQ1SV5Fw';
  let supa = null;
  try { if (window.supabase) supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth: { persistSession:false } }); } catch(_){}

  const top10gEl = document.getElementById('top10g');
  const lbStatusEl = document.getElementById('lbStatus');

  function escapeHtml(s){ return String(s).replace(/[&<>\"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

  async function lbSubmitGlobal(name, score){
    if(!supa) return;
    try{
      const { error } = await supa.from('scores').insert({ name: (name||'Anon').slice(0,20), score });
      if(error){ lbStatusEl.textContent='Skor kaydedilemedi.'; }
    }catch(_){ lbStatusEl.textContent='Skor kaydedilemedi.'; }
  }
  async function lbLoadGlobal(){
    if(!supa){ top10gEl.innerHTML='<tr><td colspan="3">Leaderboard pasif.</td></tr>'; return; }
    const { data, error } = await supa.from('scores').select('name,score').order('score',{ascending:false}).limit(10);
    if(error){ top10gEl.innerHTML = `<tr><td colspan="3">Hata: ${escapeHtml(error.message||'')}</td></tr>`; return; }
    if(!data?.length){ top10gEl.innerHTML='<tr><td colspan="3">Henüz skor yok</td></tr>'; return; }
    top10gEl.innerHTML = data.map((r,i)=>`<tr><td>${i+1}</td><td>${escapeHtml(r.name||'Anon')}</td><td>${r.score}</td></tr>`).join('');
  }

  /* ==== Oyun Durumu ==== */
  let PLAYER_NAME='', snake, dir, pendingDir, food, score, speed, tickTime, eatenCount, last, running=false;
  function reset(){ snake=[{x:Math.floor(GRID/2),y:Math.floor(GRID/2)}]; dir=pendingDir={x:1,y:0}; score=0; speed=SPEED_START; eatenCount=0; last=0; tickTime=1000/speed; spawnFood(); scoreEl.textContent='0'; }
  function spawnFood(){ while(true){ const f={x:(Math.random()*GRID)|0,y:(Math.random()*GRID)|0}; if(!snake.some(s=>s.x===f.x&&s.y===f.y)){food=f; return;} } }

  /* ==== Giriş ==== */
  window.addEventListener('keydown', (e)=>{
    if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' '].includes(e.key)) e.preventDefault();
    if(!running) return; const k=e.key.toLowerCase();
    if(e.code==='ArrowUp'   && dir.y!== 1) pendingDir={x:0,y:-1};
    if(e.code==='ArrowDown' && dir.y!==-1) pendingDir={x:0,y: 1};
    if(e.code==='ArrowLeft' && dir.x!== 1) pendingDir={x:-1,y:0};
    if(e.code==='ArrowRight'&& dir.x!==-1) pendingDir={x: 1,y:0};
    if(k==='w' && dir.y!== 1) pendingDir={x:0,y:-1};
    if(k==='s' && dir.y!==-1) pendingDir={x:0,y: 1};
    if(k==='a' && dir.x!== 1) pendingDir={x:-1,y:0};
    if(k==='d' && dir.x!==-1) pendingDir={x: 1,y:0};
  }, {passive:false});

  /* ==== Çizim ==== */
  function drawGrid(){
    ctx.fillStyle='#0b0c10'; ctx.fillRect(0,0,canvas.width,canvas.height);
    const ox=0.5; ctx.strokeStyle='#6a7fa3'; ctx.lineWidth=2.6; ctx.lineCap='butt'; ctx.lineJoin='miter';
    ctx.beginPath();
    for(let i=0;i<=GRID;i++){ const x=i*CELL+ox, y=i*CELL+ox; ctx.moveTo(x,0); ctx.lineTo(x,GRID*CELL); ctx.moveTo(0,y); ctx.lineTo(GRID*CELL,y); }
    ctx.stroke();
    ctx.save(); ctx.strokeStyle='#90a8cf'; ctx.lineWidth=3.4; ctx.strokeRect(0.5,0.5,canvas.width-1,canvas.height-1); ctx.restore();
  }
  function drawSnake(){ ctx.fillStyle='rgba(0,0,0,.18)'; snake.forEach(s=>ctx.fillRect(s.x*CELL+2,s.y*CELL+2,CELL-4,CELL-2)); ctx.fillStyle='#35c97a'; snake.forEach(s=>ctx.fillRect(s.x*CELL+1,s.y*CELL+1,CELL-2,CELL-2)); const h=snake[0]; ctx.fillStyle='#62e5a1'; ctx.fillRect(h.x*CELL+1,h.y*CELL+1,CELL-2,CELL-2); }
  function drawFood(){ ctx.fillStyle='#ff5f5f'; const r=CELL/2-3; ctx.beginPath(); ctx.arc(food.x*CELL+CELL/2, food.y*CELL+CELL/2, r, 0, Math.PI*2); ctx.fill(); }

  /* ==== Döngü ==== */
  function step(ts){
    if(!running) return;
    if(!last) last=ts; const dt=ts-last;
    if(dt>=tickTime){
      last=ts; dir=pendingDir;
      const nx=snake[0].x+dir.x, ny=snake[0].y+dir.y;
      if(nx<0||nx>=GRID||ny<0||ny>=GRID||snake.some(s=>s.x===nx&&s.y===ny)){ gameOver(); return; }
      snake.unshift({x:nx,y:ny});
      if(nx===food.x && ny===food.y){ score++; eatenCount++; scoreEl.textContent=String(score); spawnFood(); if(eatenCount%SPEED_INC_EVERY===0){ speed++; tickTime=1000/speed; } } else snake.pop();
    }
    drawGrid(); drawFood(); drawSnake();
    requestAnimationFrame(step);
  }
  function gameOver(){ running=false; finalScoreEl.textContent=String(score); gameOverOverlay.style.display='flex'; lbSubmitGlobal(PLAYER_NAME,score).then(lbLoadGlobal); }

  /* ==== Her ekranda ortalı & taşma yok: ölçekleme ==== */
  function fitScale(){
    const wrapRect = gameWrap.getBoundingClientRect();
    const availW = Math.max(320, wrapRect.width  - 8);
    const availH = Math.max(320, wrapRect.height - 40);  // HUD için biraz pay
    const sx = availW / canvas.width;
    const sy = availH / canvas.height;

    // **Önemli**: büyük ekranlarda asla büyütme → 1.0 üstüne çıkma.
    // Küçük ekranlarda küçültme serbest (0.5 altına düşmesin).
    const s = Math.max(0.6, Math.min(sx, sy, 1.0));
    canvas.style.transform = `scale(${s})`;
  }

  /* ==== Başlatma ==== */
  let PLAYER_NAME='';
  startBtn.addEventListener('click', ()=>{
    PLAYER_NAME=(nameInput.value||'').trim().slice(0,20)||'Anon';
    overlay.style.display='none';
    reset(); running=true; lbLoadGlobal(); requestAnimationFrame(step);
  });
  retryBtn.addEventListener('click', ()=>{ gameOverOverlay.style.display='none'; reset(); running=true; requestAnimationFrame(step); });

  // İlk çizimler + responsive
  drawGrid(); fitScale();
  window.addEventListener('resize', fitScale);

  // İlk açılış overlay’de olduğu için oyunu başlatınca tekrar çizilecek.
})();
</script>
</body>
</html>
